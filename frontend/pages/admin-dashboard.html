<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - MJE E-Commerce</title>
  <link rel="icon" type="image/gif" href="../mj-images/mj-logo.gif">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/responsive-fixes.css">
  <link rel="stylesheet" href="../css/admin-dashboard-enhanced.css">
  <link rel="stylesheet" href="../css/admin-notifications.css">
  <link rel="stylesheet" href="../css/admin-responsive-modal.css">
  <link rel="stylesheet" href="../css/admin-preloader.css">
  <script src="../js/admin-mobile-toggle.js" defer></script>
</head>
<body>
  <!-- Admin Preloader -->
  <div class="admin-preloader" id="adminPreloader">
    <div class="admin-preloader-content">
      <img src="../mj-images/mj-logo.gif" alt="MJ Electricals" class="admin-preloader-logo">
      <h1 class="admin-preloader-title">MJ ELECTRICALS</h1>
      <p class="admin-preloader-subtitle">Admin Dashboard</p>
      <div class="admin-spinner"></div>
      <div class="admin-progress-bar">
        <div class="admin-progress-fill"></div>
      </div>
      <p class="admin-loading-text">Loading dashboard...</p>
    </div>
  </div>

  <nav class="navbar" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ff8c42 100%); box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);">
    <div class="nav-container">
      <a href="index.html" class="logo" style="display: flex; align-items: center; gap: 0.75rem;">
        <img src="../mj-images/mj-logo.gif" alt="MJE Admin" style="height: 45px; vertical-align: middle; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
        <div style="display: flex; flex-direction: column; line-height: 1.2;">
          <span style="font-weight: 700; font-size: 1.1rem; color: white;">MJ Electricals Ghana Limited</span>
          <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9); font-weight: 500;">Admin Dashboard</span>
        </div>
      </a>
      <ul class="nav-links">
        <li><a href="admin-dashboard.html" style="color: white; font-weight: 500;"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="#" onclick="handleLogout()" style="color: white; font-weight: 500;"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="dashboard">
      <!-- Mobile Menu Toggle -->
      <button class="mobile-menu-toggle" aria-label="Toggle Menu">
        <i class="fas fa-bars"></i>
      </button>
      
      <!-- Debug Info (only visible on mobile) -->
      <div id="debug-info" style="display: none; position: fixed; top: 70px; right: 10px; background: rgba(255,107,53,0.9); color: white; padding: 10px; border-radius: 5px; z-index: 20000; font-size: 12px; max-width: 200px;">
        <strong>Debug Info:</strong><br>
        <span id="debug-text">Waiting...</span>
      </div>
      
      <!-- Sidebar Overlay -->
      <div class="sidebar-overlay"></div>
      
      <aside class="sidebar" id="admin-sidebar">
        <div class="sidebar-header">
          <h3 class="sidebar-title">Admin Panel</h3>
          <p class="sidebar-subtitle">Manage your store</p>
        </div>
        <ul class="sidebar-menu">
          <li>
            <a href="#" onclick="showSection('overview', event); return false;" class="active">
              <i class="fas fa-chart-line"></i>
              <span>Overview</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('banners', event); return false;">
              <i class="fas fa-images"></i>
              <span>Banners</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('products', event); return false;">
              <i class="fas fa-box"></i>
              <span>Products</span>
              <span class="menu-badge" id="out-of-stock-badge" style="display:none; background: #ef4444;">0</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('orders', event); return false;">
              <i class="fas fa-shopping-cart"></i>
              <span>Orders</span>
              <span class="menu-badge" id="pending-orders-badge" style="display:none;">0</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('feedback', event); return false;">
              <i class="fas fa-comments"></i>
              <span>Feedback</span>
              <span class="menu-badge" id="pending-feedback-badge" style="display:none;">0</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('reviews', event); return false;">
              <i class="fas fa-star"></i>
              <span>Reviews</span>
              <span class="menu-badge" id="pending-reviews-badge" style="display:none;">0</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('categories', event); return false;">
              <i class="fas fa-tags"></i>
              <span>Categories</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('delivery', event); return false;">
              <i class="fas fa-truck"></i>
              <span>Delivery Charges</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('newsletter', event); return false;">
              <i class="fas fa-envelope"></i>
              <span>Newsletter</span>
            </a>
          </li>
          <li style="margin-top: 2rem; border-top: 2px solid var(--gray-200); padding-top: 1rem;">
            <a href="index.html" style="color: #10b981; font-weight: 600;">
              <i class="fas fa-store"></i>
              <span>Go to Store</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="handleLogout(); return false;" style="color: #ef4444; font-weight: 600;">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </aside>

      <main class="dashboard-content">
        <div id="alert-container"></div>

        <section id="overview-section">
          <h2>Dashboard Overview</h2>
          <div class="stats-grid mt-2">
            <div class="stat-card">
              <div class="stat-value" id="stat-products">0</div>
              <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="stat-orders">0</div>
              <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="stat-pending">0</div>
              <div class="stat-label">Pending Orders</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="stat-feedback">0</div>
              <div class="stat-label">Pending Feedback</div>
            </div>
          </div>

          <!-- Financial Analytics Section -->
          <div style="margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0;"><i class="fas fa-chart-bar"></i> Financial Analytics</h3>
              <input type="date" id="analytics-date" onchange="loadFinancialAnalytics(this.value)" 
                     style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 5px;">
            </div>
            
            <div class="stats-grid">
              <div class="stat-card" style="border-left: 4px solid #10b981;">
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value" id="analytics-total-revenue" style="color: #10b981;">GHâ‚µ 0</div>
              </div>
              <div class="stat-card" style="border-left: 4px solid #3b82f6;">
                <div class="stat-label">Paid Revenue</div>
                <div class="stat-value" id="analytics-paid-revenue" style="color: #3b82f6;">GHâ‚µ 0</div>
              </div>
              <div class="stat-card" style="border-left: 4px solid #ef4444;">
                <div class="stat-label">Refunded</div>
                <div class="stat-value" id="analytics-refunded" style="color: #ef4444;">GHâ‚µ 0</div>
              </div>
              <div class="stat-card" style="border-left: 4px solid #f59e0b;">
                <div class="stat-label">Pending</div>
                <div class="stat-value" id="analytics-pending" style="color: #f59e0b;">GHâ‚µ 0</div>
              </div>
              <div class="stat-card" style="border-left: 4px solid #ff6b35;">
                <div class="stat-label">Net Revenue</div>
                <div class="stat-value" id="analytics-net-revenue" style="color: #ff6b35; font-size: 1.8rem; font-weight: 700;">GHâ‚µ 0</div>
              </div>
              <div class="stat-card" style="border-left: 4px solid #06b6d4;">
                <div class="stat-label">Orders Today</div>
                <div class="stat-value" id="analytics-orders-count" style="color: #06b6d4;">0</div>
              </div>
            </div>

            <!-- Recent Activities -->
            <div style="margin-top: 2rem; background: white; padding: 1.5rem; border-radius: 10px; box-shadow: var(--shadow-md);">
              <h4 style="margin-top: 0;"><i class="fas fa-history"></i> Recent Activities</h4>
              <div id="recent-activities" style="max-height: 300px; overflow-y: auto;">
                <div class="loading"><div class="spinner"></div></div>
              </div>
            </div>
          </div>
        </section>

        <section id="banners-section" style="display:none;">
          <h2>Manage Banners</h2>
          <button class="btn mt-2" onclick="showBannerForm()">Add New Banner</button>
          
          <div id="banner-form" style="display:none; max-width: 600px; margin-top: 1rem;">
            <h3>Banner Details</h3>
            <form id="banner-form-element">
              <input type="hidden" id="banner-id">
              <div class="form-group">
                <label>Title</label>
                <input type="text" id="banner-title" required>
              </div>
              <div class="form-group">
                <label>Subtitle</label>
                <input type="text" id="banner-subtitle">
              </div>
              <div class="form-group">
                <label>Banner Image</label>
                <input type="file" id="banner-image-file" accept="image/*" onchange="handleBannerImageSelect(event)">
                <input type="text" id="banner-image" placeholder="Or enter image URL" style="margin-top: 0.5rem;">
                <div id="banner-image-preview" style="margin-top: 0.5rem;"></div>
              </div>
              <div class="form-group">
                <label>Link (Optional)</label>
                <input type="text" id="banner-link" placeholder="e.g., products.html">
              </div>
              <div class="form-group">
                <label>Status</label>
                <select id="banner-status">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
              <div class="form-group">
                <label>Order</label>
                <input type="number" id="banner-order" value="0" min="0">
                <small>Lower numbers appear first</small>
              </div>
              <button type="submit" class="btn">Save Banner</button>
              <button type="button" class="btn btn-secondary" onclick="hideBannerForm()">Cancel</button>
            </form>
          </div>

          <div id="banners-list" class="mt-3">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </section>

        <section id="products-section" style="display:none;">
          <h2>Manage Products</h2>
          <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; align-items: center;">
            <button class="btn" onclick="showProductForm()">Add New Product</button>
            <input type="text" id="product-search" placeholder="Search products by name, ID, or category..." 
                   style="flex: 1; min-width: 300px; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 5px;"
                   oninput="searchProducts(this.value)">
          </div>
          
          <div id="product-form" style="display:none; max-width: 600px; margin-top: 1rem;">
            <h3>Product Details</h3>
            <form id="product-form-element">
              <input type="hidden" id="product-id">
              <div class="form-group">
                <label>Name</label>
                <input type="text" id="product-name" required>
              </div>
              <div class="form-group">
                <label>Category</label>
                <select id="product-category" required></select>
              </div>
              <div class="form-group">
                <label>Wattage</label>
                <input type="number" id="product-wattage" required>
              </div>
              <div class="form-group">
                <label>Old Price (GHâ‚µ) - Optional</label>
                <input type="number" step="0.01" id="product-old-price" min="0" placeholder="Enter original price if on sale" oninput="calculateDiscount()">
                <small>Leave empty if product is not on sale</small>
              </div>
              <div class="form-group">
                <label>New Price (GHâ‚µ)</label>
                <input type="number" step="0.01" id="product-price" required oninput="calculateDiscount()">
              </div>
              <div class="form-group">
                <label>Discount (%)</label>
                <input type="number" step="1" min="0" max="100" id="product-discount" value="0" readonly style="background: #f5f5f5;">
                <small id="discount-info" style="color: #10b981; font-weight: 600;"></small>
              </div>
              <div class="form-group">
                <label>Stock</label>
                <input type="number" id="product-stock" required>
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea id="product-description" rows="3" required></textarea>
              </div>
              <div class="form-group">
                <label>Product Image</label>
                <input type="file" id="product-image-file" accept="image/*" onchange="handleImageSelect(event)">
                <input type="text" id="product-image" placeholder="Or enter image URL" style="margin-top: 0.5rem;">
                <div id="image-preview" style="margin-top: 0.5rem;"></div>
              </div>
              <div class="form-group">
                <label>Status</label>
                <select id="product-status">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
              <button type="submit" class="btn">Save Product</button>
              <button type="button" class="btn btn-secondary" onclick="hideProductForm()">Cancel</button>
            </form>
          </div>

          <div id="products-list" class="mt-3">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </section>

        <section id="orders-section" style="display:none;">
          <h2>Manage Orders</h2>
          <div style="margin-top: 1rem;">
            <input type="text" id="order-search" placeholder="Search orders by ID, customer name, or email..." 
                   style="width: 100%; max-width: 500px; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 5px;"
                   oninput="searchOrders(this.value)">
          </div>
          <div id="orders-list" class="mt-2">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </section>

        <section id="feedback-section" style="display:none;">
          <h2>Customer Feedback</h2>
          <div id="feedback-list" class="mt-2">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </section>

        <section id="categories-section" style="display:none;">
          <h2>Manage Categories</h2>
          <form id="category-form" style="max-width: 400px;" class="mt-2">
            <div class="form-group">
              <label>Category Name</label>
              <input type="text" id="category-name" required>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="category-description" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Category Image</label>
              <input type="file" id="category-image-file" accept="image/*" onchange="handleCategoryImageSelect(event)">
              <input type="text" id="category-image" placeholder="Or enter image URL" style="margin-top: 0.5rem;">
              <div id="category-image-preview" style="margin-top: 0.5rem;"></div>
            </div>
            <button type="submit" class="btn">Add Category</button>
          </form>
          <div id="categories-list" class="mt-3"></div>
        </section>

        <section id="delivery-section" style="display:none;">
          <h2>Manage Delivery Charges</h2>
          <button class="btn mt-2" onclick="showDeliveryForm()">Add New City</button>
          
          <div id="delivery-form" style="display:none; max-width: 500px; margin-top: 1rem;">
            <h3>Delivery Charge Details</h3>
            <form id="delivery-form-element">
              <input type="hidden" id="delivery-id">
              <div class="form-group">
                <label>City Name *</label>
                <input type="text" id="delivery-city" required placeholder="e.g., Accra, Kumasi">
              </div>
              <div class="form-group">
                <label>Delivery Charge (GHâ‚µ) *</label>
                <input type="number" step="0.01" id="delivery-charge" required placeholder="e.g., 55.00">
              </div>
              <div class="form-group">
                <label>Estimated Delivery Days</label>
                <input type="text" id="delivery-days" placeholder="e.g., 2-3 business days">
              </div>
              <div class="form-group">
                <label>Status</label>
                <select id="delivery-status">
                  <option value="true">Active</option>
                  <option value="false">Inactive</option>
                </select>
              </div>
              <button type="submit" class="btn">Save Delivery Charge</button>
              <button type="button" class="btn btn-secondary" onclick="hideDeliveryForm()">Cancel</button>
            </form>
          </div>

          <div id="delivery-list" class="mt-3">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </section>

        <section id="newsletter-section" style="display:none;">
          <h2>Newsletter Subscribers</h2>
          <div class="mt-2">
            <p>Total Subscribers: <strong id="newsletter-count">0</strong></p>
          </div>
          <div class="table-container mt-2">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Subscribed Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="newsletter-list">
                <tr><td colspan="3" class="text-center">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <section id="reviews-section" style="display:none;">
          <h2>Manage Reviews</h2>
          
          <!-- Filter Tabs -->
          <div style="margin: 1.5rem 0; display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn" onclick="filterReviews('pending')" id="filter-pending-reviews">Pending</button>
            <button class="btn btn-secondary" onclick="filterReviews('approved')" id="filter-approved-reviews">Approved</button>
            <button class="btn btn-secondary" onclick="filterReviews('rejected')" id="filter-rejected-reviews">Rejected</button>
            <button class="btn btn-secondary" onclick="filterReviews('all')" id="filter-all-reviews">All Reviews</button>
          </div>

          <div id="reviews-list" class="mt-2">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="../js/utils.js"></script>
  <script src="../js/toast.js"></script>
  <script src="../js/modal.js"></script>
  <script src="../js/logger.js"></script>`n  <script src="../js/api.js"></script>
  <script src="../js/state.js"></script>
  <script src="../js/socket.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/mobile-table-helper.js"></script>
  <script>
    // Wait for user to load before checking role
    document.addEventListener('DOMContentLoaded', async () => {
      // Hide preloader after minimum time
      setTimeout(() => {
        const preloader = document.getElementById('adminPreloader');
        if (preloader) {
          preloader.classList.add('hidden');
          setTimeout(() => preloader.remove(), 500);
        }
      }, 2000);

      if (!requireAuth()) {
        return;
      }
      
      // Wait for user data to load
      await stateManager.loadUser();
      const state = stateManager.getState();
      
      // Check if user is admin or super admin
      if (!state.user || !['admin', 'superadmin'].includes(state.user.role)) {
        window.location.href = 'index.html';
        return;
      }
      
      // User is authenticated and has admin access, load the page
      loadStats();
      
      // Restore last viewed section
      const lastSection = localStorage.getItem('adminCurrentSection');
      if (lastSection && lastSection !== 'overview') {
        setTimeout(() => {
          showSection(lastSection);
        }, 100);
      }
    });

    function showSection(section, event) {
      // Save current section to localStorage
      localStorage.setItem('adminCurrentSection', section);
      
      // Hide all sections
      document.querySelectorAll('.dashboard-content section').forEach(s => {
        s.style.display = 'none';
      });
      
      // Show selected section
      const targetSection = document.getElementById(`${section}-section`);
      if (targetSection) {
        targetSection.style.display = 'block';
      }

      // Update active menu item
      document.querySelectorAll('.sidebar-menu a').forEach(a => {
        a.classList.remove('active');
      });
      
      // Handle event properly - get the anchor element
      if (event) {
        const target = event.target.closest('a');
        if (target) {
          target.classList.add('active');
        }
      } else {
        // Find and activate the correct link when no event (page load)
        const targetLink = document.querySelector(`[onclick*="showSection('${section}'"]`);
        if (targetLink) {
          targetLink.classList.add('active');
        }
      }

      // Close mobile sidebar after selection
      if (window.innerWidth <= 968 && window.toggleMobileSidebar) {
        window.toggleMobileSidebar();
      }

      // Load section data
      if (section === 'banners') loadBanners();
      if (section === 'products') loadProducts();
      if (section === 'orders') loadOrders();
      if (section === 'feedback') loadFeedback();
      if (section === 'categories') loadCategories();
      if (section === 'delivery') loadDeliveryCharges();
      if (section === 'newsletter') loadNewsletterSubscribers();
      if (section === 'reviews') loadReviews();
    }

    async function loadStats() {
      try {
        const response = await api.getDashboardStats();
        document.getElementById('stat-products').textContent = response.stats.totalProducts;
        document.getElementById('stat-orders').textContent = response.stats.totalOrders;
        document.getElementById('stat-pending').textContent = response.stats.pendingOrders;
        document.getElementById('stat-feedback').textContent = response.stats.pendingFeedbacks;
        
        // Update badges
        if (response.stats.pendingOrders > 0) {
          const badge = document.getElementById('pending-orders-badge');
          badge.textContent = response.stats.pendingOrders;
          badge.style.display = 'inline-block';
        }
        if (response.stats.pendingFeedbacks > 0) {
          const badge = document.getElementById('pending-feedback-badge');
          badge.textContent = response.stats.pendingFeedbacks;
          badge.style.display = 'inline-block';
        }

        // Check for out-of-stock products
        await updateOutOfStockBadge();

        // Check for pending reviews
        await updatePendingReviewsBadge();

        // Show notifications for new orders and out-of-stock products
        await showAdminNotifications(response.stats);

        // Load financial analytics for today
        loadFinancialAnalytics();
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    // Show admin notifications on page load
    async function showAdminNotifications(stats) {
      const alertContainer = document.getElementById('alert-container');
      const notifications = [];

      // Check for processing orders (paid but not yet shipped)
      if (stats.pendingOrders > 0) {
        notifications.push({
          type: 'info',
          icon: 'ðŸ””',
          title: `${stats.pendingOrders} Order${stats.pendingOrders > 1 ? 's' : ''} Processing`,
          message: `You have ${stats.pendingOrders} paid order${stats.pendingOrders > 1 ? 's' : ''} ready to be shipped.`,
          action: () => showSection('orders')
        });
      }

      // Check for out-of-stock products
      try {
        const response = await api.getProducts({ limit: 1000 });
        const outOfStockProducts = response.products.filter(p => p.stock === 0);
        const lowStockProducts = response.products.filter(p => p.stock > 0 && p.stock <= 5);

        if (outOfStockProducts.length > 0) {
          notifications.push({
            type: 'error',
            icon: 'ðŸš¨',
            title: `${outOfStockProducts.length} Product${outOfStockProducts.length > 1 ? 's' : ''} Out of Stock`,
            message: `${outOfStockProducts.map(p => p.name).slice(0, 3).join(', ')}${outOfStockProducts.length > 3 ? ` and ${outOfStockProducts.length - 3} more` : ''}`,
            action: () => showSection('products')
          });
        }

        if (lowStockProducts.length > 0) {
          notifications.push({
            type: 'warning',
            icon: 'âš ï¸',
            title: `${lowStockProducts.length} Product${lowStockProducts.length > 1 ? 's' : ''} Low on Stock`,
            message: `${lowStockProducts.map(p => `${p.name} (${p.stock} left)`).slice(0, 2).join(', ')}${lowStockProducts.length > 2 ? ` and ${lowStockProducts.length - 2} more` : ''}`,
            action: () => showSection('products')
          });
        }
      } catch (error) {
        console.error('Failed to check stock:', error);
      }

      // Check for pending feedback
      if (stats.pendingFeedbacks > 0) {
        notifications.push({
          type: 'info',
          icon: 'ðŸ’¬',
          title: `${stats.pendingFeedbacks} New Feedback`,
          message: `You have ${stats.pendingFeedbacks} customer feedback${stats.pendingFeedbacks > 1 ? 's' : ''} waiting for response.`,
          action: () => showSection('feedback')
        });
      }

      // Display notifications
      if (notifications.length > 0) {
        alertContainer.innerHTML = notifications.map((notif, index) => `
          <div class="admin-notification ${notif.type}" style="animation-delay: ${index * 0.1}s">
            <div class="notification-icon">${notif.icon}</div>
            <div class="notification-content">
              <div class="notification-title">${notif.title}</div>
              <div class="notification-message">${notif.message}</div>
            </div>
            <button class="notification-action" onclick="event.stopPropagation(); ${notif.action.toString().match(/showSection\('([^']+)'\)/)?.[0] || ''}">
              View
            </button>
            <button class="notification-close" onclick="this.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `).join('');
      }
    }

    // Update out-of-stock badge
    async function updateOutOfStockBadge() {
      try {
        const response = await api.getProducts({ limit: 1000 });
        const outOfStockCount = response.products.filter(p => p.stock === 0).length;
        
        const badge = document.getElementById('out-of-stock-badge');
        if (outOfStockCount > 0) {
          badge.textContent = outOfStockCount;
          badge.style.display = 'inline-block';
          
          // Change Products link color to red if there are out-of-stock items
          const productsLink = badge.closest('a');
          if (productsLink) {
            productsLink.style.color = '#ef4444';
          }
        } else {
          badge.style.display = 'none';
          const productsLink = badge.closest('a');
          if (productsLink) {
            productsLink.style.color = '';
          }
        }
      } catch (error) {
        console.error('Failed to check out-of-stock products:', error);
      }
    }

    // Financial Analytics
    async function loadFinancialAnalytics(date) {
      try {
        const response = await api.getFinancialAnalytics(date);
        const analytics = response.analytics;

        // Update analytics cards
        document.getElementById('analytics-total-revenue').textContent = formatPrice(analytics.revenue.total);
        document.getElementById('analytics-paid-revenue').textContent = formatPrice(analytics.revenue.paid);
        document.getElementById('analytics-refunded').textContent = formatPrice(analytics.revenue.refunded);
        document.getElementById('analytics-pending').textContent = formatPrice(analytics.revenue.pending);
        document.getElementById('analytics-net-revenue').textContent = formatPrice(analytics.revenue.net);
        document.getElementById('analytics-orders-count').textContent = analytics.orders.total;

        // Set date input to current date if not set
        if (!date) {
          document.getElementById('analytics-date').valueAsDate = new Date();
        }

        // Display recent activities
        const activitiesContainer = document.getElementById('recent-activities');
        if (analytics.recentActivities.length === 0) {
          activitiesContainer.innerHTML = '<p style="text-align: center; color: var(--gray-600); padding: 1rem;">No activities for this date</p>';
        } else {
          activitiesContainer.innerHTML = analytics.recentActivities.map(activity => `
            <div style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>Order #${activity.id.slice(-8)}</strong>
                <span class="status-badge ${activity.status}" style="margin-left: 0.5rem;">${activity.status}</span>
                ${activity.refundStatus === 'processed' ? '<span style="color: #10b981; margin-left: 0.5rem;"><i class="fas fa-undo"></i> Refunded</span>' : ''}
              </div>
              <div style="text-align: right;">
                <strong style="color: var(--primary-orange);">${formatPrice(activity.amount)}</strong>
                <p style="margin: 0; font-size: 0.85rem; color: var(--gray-600);">${new Date(activity.createdAt).toLocaleTimeString()}</p>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Failed to load financial analytics:', error);
      }
    }

    // Store all products and orders for search
    let allProducts = [];
    let allOrders = [];

    let currentProductsPage = 1;
    const productsPerPage = 20;

    async function loadProducts() {
      try {
        const response = await api.getProducts({ limit: 1000 });
        allProducts = response.products;
        displayProducts(allProducts, 1);
        
        // Update out-of-stock badge
        await updateOutOfStockBadge();
      } catch (error) {
        document.getElementById('products-list').innerHTML = '<p>Failed to load products</p>';
      }
    }

    function displayProducts(products, page = 1) {
      const container = document.getElementById('products-list');
      currentProductsPage = page;

      if (products.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--gray-600);">No products found</p>';
        return;
      }

      // Calculate pagination
      const totalPages = Math.ceil(products.length / productsPerPage);
      const startIndex = (page - 1) * productsPerPage;
      const endIndex = startIndex + productsPerPage;
      const paginatedProducts = products.slice(startIndex, endIndex);

      container.innerHTML = `
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
          <p style="color: var(--gray-600);">Showing ${startIndex + 1}-${Math.min(endIndex, products.length)} of ${products.length} products</p>
          <div class="pagination">
            <button class="btn btn-secondary" onclick="displayProducts(allProducts, ${page - 1})" ${page === 1 ? 'disabled' : ''}>
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <span style="margin: 0 1rem;">Page ${page} of ${totalPages}</span>
            <button class="btn btn-secondary" onclick="displayProducts(allProducts, ${page + 1})" ${page === totalPages ? 'disabled' : ''}>
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        <div class="table-container">
          <table>
              <thead>
                <tr>
                  <th>Product ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${paginatedProducts.map(p => {
                  const stockColor = p.stock === 0 ? '#ef4444' : p.stock <= 5 ? '#f59e0b' : '#10b981';
                  const stockIcon = p.stock === 0 ? 'ðŸš¨' : p.stock <= 5 ? 'âš ï¸' : 'âœ“';
                  const stockText = p.stock === 0 ? 'OUT OF STOCK' : p.stock <= 5 ? `LOW STOCK (${p.stock})` : p.stock;
                  
                  return `
                  <tr style="${p.stock === 0 ? 'background: #fee2e2;' : p.stock <= 5 ? 'background: #fef3c7;' : ''}">
                    <td>${p.productId}</td>
                    <td>${p.name}</td>
                    <td>${p.category}</td>
                    <td>${formatPrice(p.price)}</td>
                    <td style="color: ${stockColor}; font-weight: 600;">
                      ${stockIcon} ${stockText}
                    </td>
                    <td>${p.status}</td>
                    <td>
                      <button class="btn btn-secondary" onclick='editProduct(${JSON.stringify(p)})'>Edit</button>
                      <button class="btn btn-secondary" onclick="deleteProduct('${p._id}')">Delete</button>
                    </td>
                  </tr>
                `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
    }

    function searchProducts(query) {
      if (!query.trim()) {
        displayProducts(allProducts, 1);
        return;
      }

      const filtered = allProducts.filter(p => 
        p.name.toLowerCase().includes(query.toLowerCase()) ||
        p.productId.toLowerCase().includes(query.toLowerCase()) ||
        p.category.toLowerCase().includes(query.toLowerCase())
      );
      
      displayProducts(filtered, 1);
    }

    function showProductForm() {
      document.getElementById('product-form').style.display = 'block';
      loadCategoriesForSelect();
    }

    function hideProductForm() {
      document.getElementById('product-form').style.display = 'none';
      document.getElementById('product-form-element').reset();
      document.getElementById('product-id').value = '';
      document.getElementById('image-preview').innerHTML = '';
      document.getElementById('discount-info').textContent = '';
      document.getElementById('product-discount').value = 0;
    }

    async function loadCategoriesForSelect() {
      try {
        const response = await api.getCategories();
        const select = document.getElementById('product-category');
        select.innerHTML = response.categories.map(cat => 
          `<option value="${cat.name}">${cat.name}</option>`
        ).join('');
      } catch (error) {
        console.error('Failed to load categories:', error);
      }
    }

    function editProduct(product) {
      showProductForm();
      document.getElementById('product-id').value = product._id;
      document.getElementById('product-name').value = product.name;
      document.getElementById('product-category').value = product.category;
      document.getElementById('product-wattage').value = product.wattage;
      document.getElementById('product-old-price').value = product.oldPrice || '';
      document.getElementById('product-price').value = product.price;
      document.getElementById('product-discount').value = product.discount || 0;
      document.getElementById('product-stock').value = product.stock;
      document.getElementById('product-description').value = product.description;
      document.getElementById('product-image').value = product.images[0] || '';
      document.getElementById('product-status').value = product.status;
      
      // Update discount info display
      if (product.oldPrice && product.oldPrice > product.price) {
        const discountPercent = Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100);
        document.getElementById('discount-info').textContent = `${discountPercent}% off - Save GHâ‚µ ${(product.oldPrice - product.price).toFixed(2)}`;
      }
      
      if (product.images[0]) {
        document.getElementById('image-preview').innerHTML = 
          `<img src="${product.images[0]}" style="max-width: 200px; border-radius: 5px;">`;
      }
    }

    // Calculate discount percentage automatically
    function calculateDiscount() {
      const oldPrice = parseFloat(document.getElementById('product-old-price').value) || 0;
      const newPrice = parseFloat(document.getElementById('product-price').value) || 0;
      
      if (oldPrice > 0 && newPrice > 0 && oldPrice > newPrice) {
        const discountPercent = Math.round(((oldPrice - newPrice) / oldPrice) * 100);
        const savings = (oldPrice - newPrice).toFixed(2);
        
        document.getElementById('product-discount').value = discountPercent;
        document.getElementById('discount-info').textContent = `${discountPercent}% off - Save GHâ‚µ ${savings}`;
        document.getElementById('discount-info').style.display = 'block';
      } else {
        document.getElementById('product-discount').value = 0;
        document.getElementById('discount-info').textContent = '';
        document.getElementById('discount-info').style.display = 'none';
      }
    }

    document.getElementById('product-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const oldPrice = parseFloat(document.getElementById('product-old-price').value) || 0;
      const newPrice = parseFloat(document.getElementById('product-price').value);
      
      const productData = {
        name: document.getElementById('product-name').value,
        category: document.getElementById('product-category').value,
        wattage: document.getElementById('product-wattage').value,
        oldPrice: oldPrice,
        price: newPrice,
        discount: parseInt(document.getElementById('product-discount').value) || 0,
        stock: document.getElementById('product-stock').value,
        description: document.getElementById('product-description').value,
        images: [document.getElementById('product-image').value].filter(Boolean),
        status: document.getElementById('product-status').value
      };

      try {
        const productId = document.getElementById('product-id').value;
        if (productId) {
          await api.updateProduct(productId, productData);
          showAlert(`"${productData.name}" updated successfully`, 'success');
        } else {
          await api.createProduct(productData);
          showAlert(`"${productData.name}" added successfully`, 'success');
        }
        hideProductForm();
        loadProducts();
        loadStats();
      } catch (error) {
        showAlert(error.message || 'Failed to save product', 'error');
      }
    });

    async function deleteProduct(id) {
      Modal.confirm('Are you sure you want to delete this product?', async () => {
        try {
          const product = await api.getProduct(id);
          await api.deleteProduct(id);
          showAlert(`"${product.product.name}" deleted successfully`, 'success');
          loadProducts();
          loadStats();
        } catch (error) {
          showAlert(error.message || 'Failed to delete product', 'error');
        }
      });
    }

    let currentOrdersPage = 1;
    const ordersPerPage = 20;

    async function loadOrders() {
      try {
        const response = await api.getAllOrders();
        allOrders = response.orders;
        displayOrders(allOrders, 1);
      } catch (error) {
        document.getElementById('orders-list').innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">ðŸ“¦ No orders available yet</p>';
      }
    }

    function displayOrders(orders, page = 1) {
      const container = document.getElementById('orders-list');
      currentOrdersPage = page;

      if (orders.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--gray-600);">No orders found</p>';
        return;
      }

      // Calculate pagination
      const totalPages = Math.ceil(orders.length / ordersPerPage);
      const startIndex = (page - 1) * ordersPerPage;
      const endIndex = startIndex + ordersPerPage;
      const paginatedOrders = orders.slice(startIndex, endIndex);

      container.innerHTML = `
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
          <p style="color: var(--gray-600);">Showing ${startIndex + 1}-${Math.min(endIndex, orders.length)} of ${orders.length} orders</p>
          <div class="pagination">
            <button class="btn btn-secondary" onclick="displayOrders(allOrders, ${page - 1})" ${page === 1 ? 'disabled' : ''}>
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <span style="margin: 0 1rem;">Page ${page} of ${totalPages}</span>
            <button class="btn btn-secondary" onclick="displayOrders(allOrders, ${page + 1})" ${page === totalPages ? 'disabled' : ''}>
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${paginatedOrders.map(order => `
                <tr>
                  <td>${order.orderId || '#' + order._id.slice(-8)}</td>
                  <td>${order.user.name}</td>
                  <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                  <td>${formatPrice(order.totalAmount)}</td>
                  <td>${order.status}</td>
                  <td>
                    <button class="btn" style="padding: 0.5rem 1rem; font-size: 0.85rem; margin-right: 0.5rem;" onclick='viewAdminOrderDetails(${JSON.stringify(order).replace(/'/g, "&#39;")})'>
                      <i class="fas fa-eye"></i> View
                    </button>
                    ${order.status === 'cancelled' && order.refundStatus !== 'processed' ? `
                      <button class="btn" style="padding: 0.5rem 1rem; font-size: 0.85rem; margin-right: 0.5rem; background: #10b981;" onclick="processOrderRefund('${order._id}')">
                        <i class="fas fa-money-bill-wave"></i> Process Refund
                      </button>
                    ` : order.refundStatus === 'processed' ? `
                      <span style="color: #10b981; font-weight: 600; font-size: 0.85rem;">
                        <i class="fas fa-check-circle"></i> Refunded
                      </span>
                    ` : ''}
                    <select onchange="updateOrderStatus('${order._id}', this.value)" style="padding: 0.5rem; font-size: 0.85rem;">
                      <option value="">Change Status</option>
                      <option value="pending">Pending</option>
                      <option value="processing">Processing</option>
                      <option value="shipped">Shipped</option>
                      <option value="completed">Completed</option>
                      <option value="cancelled">Cancelled</option>
                    </select>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function searchOrders(query) {
      if (!query.trim()) {
        displayOrders(allOrders, 1);
        return;
      }

      const filtered = allOrders.filter(order =>
        order._id.toLowerCase().includes(query.toLowerCase()) ||
        order.user.name.toLowerCase().includes(query.toLowerCase()) ||
        order.status.toLowerCase().includes(query.toLowerCase())
      );
      
      displayOrders(filtered, 1);
    }

    async function updateOrderStatus(orderId, status) {
      if (!status) return;
      try {
        await api.updateOrderStatus(orderId, status);
        showAlert(`Order #${orderId.slice(-8)} status updated to "${status}"`, 'success');
        loadOrders();
        loadStats();
      } catch (error) {
        showAlert(error.message || 'Failed to update order status', 'error');
      }
    }

    async function processOrderRefund(orderId) {
      Modal.confirm(
        'Are you sure you want to process the refund for this order? This action cannot be undone.',
        async () => {
          try {
            await api.processRefund(orderId);
            showAlert(`Refund processed successfully for order #${orderId.slice(-8)}`, 'success');
            loadOrders();
            loadStats();
          } catch (error) {
            showAlert(error.message || 'Failed to process refund', 'error');
          }
        }
      );
    }

    async function loadFeedback() {
      const container = document.getElementById('feedback-list');
      try {
        container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading feedback...</p></div>';
        const response = await api.getAllFeedbacks();
        
        console.log('Feedback response:', response);
        
        if (!response || !response.feedbacks) {
          throw new Error('Invalid response format');
        }

        if (response.feedbacks.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--gray-600); padding: 2rem;">No feedback yet</p>';
          return;
        }

        container.innerHTML = response.feedbacks.map(fb => `
          <div style="background: var(--gray-light); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
            <p><strong>${fb.user?.name || 'Unknown User'}</strong> (${fb.user?.email || 'No email'})</p>
            <p>${fb.message || 'No message'}</p>
            <p><small>${new Date(fb.createdAt).toLocaleString()}</small></p>
            ${fb.status === 'pending' ? `
              <form onsubmit="respondToFeedback(event, '${fb._id}')">
                <textarea id="response-${fb._id}" placeholder="Your response..." rows="2" style="width: 100%; margin-top: 0.5rem;"></textarea>
                <button type="submit" class="btn mt-1">Send Response</button>
              </form>
            ` : `
              <div style="background: white; padding: 1rem; margin-top: 0.5rem; border-radius: 5px;">
                <p><strong>Your Response:</strong> ${fb.response}</p>
              </div>
            `}
          </div>
        `).join('');
      } catch (error) {
        console.error('Load feedback error:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <p style="color: var(--error-color); margin-bottom: 1rem;">Failed to load feedback</p>
            <p style="color: var(--gray-600); font-size: 0.9rem;">${error.message || 'Unknown error'}</p>
            <button onclick="loadFeedback()" class="btn" style="margin-top: 1rem;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      }
    }

    async function respondToFeedback(event, feedbackId) {
      event.preventDefault();
      const response = document.getElementById(`response-${feedbackId}`).value;
      try {
        await api.respondToFeedback(feedbackId, response);
        showAlert('Response sent to customer successfully', 'success');
        loadFeedback();
        loadStats();
      } catch (error) {
        showAlert(error.message || 'Failed to send response', 'error');
      }
    }

    async function loadCategories() {
      try {
        const response = await api.getCategories();
        const container = document.getElementById('categories-list');

        container.innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${response.categories.map(cat => `
                  <tr>
                    <td>${cat.name}</td>
                    <td>${cat.description || '-'}</td>
                    <td>${cat.isActive ? 'Active' : 'Inactive'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        document.getElementById('categories-list').innerHTML = '<p>Failed to load categories</p>';
      }
    }

    document.getElementById('category-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const categoryName = document.getElementById('category-name').value;
      try {
        await api.createCategory({
          name: categoryName,
          description: document.getElementById('category-description').value,
          image: document.getElementById('category-image').value
        });
        showAlert(`Category "${categoryName}" created successfully`, 'success');
        e.target.reset();
        document.getElementById('category-image-preview').innerHTML = '';
        loadCategories();
      } catch (error) {
        showAlert(error.message || 'Failed to create category', 'error');
      }
    });

    function handleCategoryImageSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('category-image-preview');
          preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; border-radius: 5px;">`;
          document.getElementById('category-image').value = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    // Banner Management
    async function loadBanners() {
      try {
        const response = await api.getBanners();
        const container = document.getElementById('banners-list');

        container.innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Title</th>
                  <th>Subtitle</th>
                  <th>Status</th>
                  <th>Order</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${response.banners.map(b => `
                  <tr>
                    <td><img src="${b.image}" style="width: 80px; height: 40px; object-fit: cover; border-radius: 5px;"></td>
                    <td>${b.title}</td>
                    <td>${b.subtitle || '-'}</td>
                    <td>${b.isActive}</td>
                    <td>${b.order}</td>
                    <td>
                      <button class="btn btn-secondary" onclick='editBanner(${JSON.stringify(b)})'>Edit</button>
                      <button class="btn btn-secondary" onclick="deleteBanner('${b._id}')">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        document.getElementById('banners-list').innerHTML = '<p>Failed to load banners</p>';
      }
    }

    function showBannerForm() {
      document.getElementById('banner-form').style.display = 'block';
    }

    function hideBannerForm() {
      document.getElementById('banner-form').style.display = 'none';
      document.getElementById('banner-form-element').reset();
      document.getElementById('banner-id').value = '';
      document.getElementById('banner-image-preview').innerHTML = '';
    }

    function handleBannerImageSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('banner-image-preview');
          preview.innerHTML = `<img src="${e.target.result}" style="max-width: 300px; border-radius: 5px;">`;
          document.getElementById('banner-image').value = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    function editBanner(banner) {
      showBannerForm();
      document.getElementById('banner-id').value = banner._id;
      document.getElementById('banner-title').value = banner.title;
      document.getElementById('banner-subtitle').value = banner.subtitle || '';
      document.getElementById('banner-image').value = banner.image;
      document.getElementById('banner-link').value = banner.link || '';
      document.getElementById('banner-status').value = banner.isActive;
      document.getElementById('banner-order').value = banner.order;
      
      if (banner.image) {
        document.getElementById('banner-image-preview').innerHTML = 
          `<img src="${banner.image}" style="max-width: 300px; border-radius: 5px;">`;
      }
    }

    document.getElementById('banner-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const bannerData = {
        title: document.getElementById('banner-title').value,
        subtitle: document.getElementById('banner-subtitle').value,
        image: document.getElementById('banner-image').value,
        link: document.getElementById('banner-link').value,
        isActive: document.getElementById('banner-status').value,
        order: document.getElementById('banner-order').value
      };

      try {
        const bannerId = document.getElementById('banner-id').value;
        if (bannerId) {
          await api.updateBanner(bannerId, bannerData);
          showAlert(`Banner "${bannerData.title}" updated successfully`, 'success');
        } else {
          await api.createBanner(bannerData);
          showAlert(`Banner "${bannerData.title}" created successfully`, 'success');
        }
        hideBannerForm();
        loadBanners();
      } catch (error) {
        showAlert(error.message || 'Failed to save banner', 'error');
      }
    });

    async function deleteBanner(id) {
      Modal.confirm('Are you sure you want to delete this banner?', async () => {
        try {
          await api.deleteBanner(id);
          showAlert('Banner deleted successfully', 'success');
          loadBanners();
        } catch (error) {
          showAlert(error.message || 'Failed to delete banner', 'error');
        }
      });
    }

    function handleImageSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('image-preview');
          preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; border-radius: 5px;">`;
          document.getElementById('product-image').value = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    async function loadNewsletterSubscribers() {
      try {
        const response = await api.getNewsletterSubscribers();
        const list = document.getElementById('newsletter-list');
        document.getElementById('newsletter-count').textContent = response.count || 0;
        
        if (!response.subscribers || response.subscribers.length === 0) {
          list.innerHTML = '<tr><td colspan="3" class="text-center">No subscribers yet</td></tr>';
          return;
        }

        list.innerHTML = response.subscribers.map(sub => `
          <tr>
            <td>${sub.email}</td>
            <td>${new Date(sub.createdAt).toLocaleDateString()}</td>
            <td><span style="color: ${sub.isActive ? 'green' : 'red'}">${sub.isActive ? 'Active' : 'Inactive'}</span></td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load newsletter subscribers:', error);
        document.getElementById('newsletter-list').innerHTML = 
          '<tr><td colspan="3" class="text-center">Failed to load subscribers</td></tr>';
      }
    }

    // Helper function for status colors - MUST BE DEFINED BEFORE USE
    function getStatusColor(status) {
      const colors = {
        'pending': '#f59e0b',
        'processing': '#3b82f6',
        'shipped': '#8b5cf6',
        'completed': '#10b981',
        'cancelled': '#ef4444'
      };
      return colors[status] || '#666';
    }

    // Helper function to format address
    function formatAddress(addr) {
      if (!addr) return 'N/A';
      if (typeof addr === 'string') return addr;
      return `${addr.street || ''}, ${addr.city || ''}, ${addr.state || ''} ${addr.zipCode || ''}, ${addr.country || ''}`.replace(/,\s*,/g, ',').trim();
    }

    function viewAdminOrderDetails(order) {
      const itemsList = order.items.map((item, index) => `
        <tr>
          <td data-label="Product">${item.name}</td>
          <td data-label="Code">${item.productId}</td>
          <td data-label="Quantity">${item.quantity}</td>
          <td data-label="Price">GHâ‚µ ${item.price?.toFixed(2) || '0.00'}</td>
          <td data-label="Total">GHâ‚µ ${(item.quantity * (item.price || 0)).toFixed(2)}</td>
        </tr>
      `).join('');

      const modalHTML = `
        <div class="admin-modal" id="orderDetailsModal" onclick="closeOrderModal(event)">
          <div class="admin-modal-content" onclick="event.stopPropagation()">
            <div class="admin-modal-header">
              <h3>Order Details - ${order.orderId || '#' + order._id.slice(-8)}</h3>
              <button class="admin-modal-close" onclick="closeOrderModal()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="admin-modal-body">
              <div class="order-details-grid">
                <div class="order-info-card">
                  <h4>Customer</h4>
                  <p>${order.customerInfo?.fullName || order.user?.name || 'Unknown'}</p>
                </div>
                <div class="order-info-card">
                  <h4>Email</h4>
                  <p>${order.customerInfo?.email || order.user?.email || 'N/A'}</p>
                </div>
                <div class="order-info-card">
                  <h4>Phone</h4>
                  <p>${order.customerInfo?.phone || 'Not provided'}</p>
                </div>
                <div class="order-info-card">
                  <h4>Status</h4>
                  <p><span class="status-badge ${order.status}">${order.status}</span></p>
                </div>
                <div class="order-info-card">
                  <h4>Payment</h4>
                  <p><span class="status-badge ${order.paymentStatus}">${order.paymentStatus}</span></p>
                </div>
                <div class="order-info-card">
                  <h4>Total Amount</h4>
                  <p><strong>GHâ‚µ ${order.totalAmount?.toFixed(2) || '0.00'}</strong></p>
                </div>
                <div class="order-info-card">
                  <h4>Order Date</h4>
                  <p>${new Date(order.createdAt).toLocaleDateString()}</p>
                </div>
                <div class="order-info-card">
                  <h4>Payment Method</h4>
                  <p>${order.paymentMethod || 'N/A'}</p>
                </div>
              </div>

              <h4 style="margin: 2rem 0 1rem 0; color: #374151;">Order Items</h4>
              <div class="order-items-container">
                <table class="order-items-table">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Code</th>
                      <th>Quantity</th>
                      <th>Price</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${itemsList}
                  </tbody>
                </table>
              </div>

              ${order.shippingAddress ? `
                <h4 style="margin: 2rem 0 1rem 0; color: #374151;">Shipping Address</h4>
                <div class="order-info-card">
                  <p>${formatAddress(order.shippingAddress)}</p>
                </div>
              ` : ''}

              <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                <select onchange="updateOrderStatus('${order._id}', this.value)" 
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; flex: 1; min-width: 150px;">
                  <option value="">Update Status</option>
                  <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                  <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                  <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
                ${order.paymentStatus === 'paid' && order.status !== 'cancelled' ? `
                  <button onclick="processRefund('${order._id}')" 
                          style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Process Refund
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
      document.body.style.overflow = 'hidden';
    }

    function closeOrderModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('orderDetailsModal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
      }
    }
    }

    // Delivery Charges Management
    async function loadDeliveryCharges() {
      try {
        const response = await api.getDeliveryCharges();
        const container = document.getElementById('delivery-list');

        if (!response.deliveryCharges || response.deliveryCharges.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--gray-600);">No delivery charges configured yet. Add your first city!</p>';
          return;
        }

        container.innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>City</th>
                  <th>Charge</th>
                  <th>Delivery Time</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${response.deliveryCharges.map(charge => `
                  <tr>
                    <td><strong>${charge.city}</strong></td>
                    <td>${formatPrice(charge.charge)}</td>
                    <td>${charge.estimatedDays || 'N/A'}</td>
                    <td>
                      <span style="color: ${charge.active ? '#28a745' : '#dc3545'}; font-weight: 600;">
                        ${charge.active ? 'Active' : 'Inactive'}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.85rem; margin-right: 0.5rem;" 
                              onclick='editDeliveryCharge(${JSON.stringify(charge).replace(/'/g, "&#39;")})'>
                        Edit
                      </button>
                      <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.85rem;" 
                              onclick="deleteDeliveryCharge('${charge._id}')">
                        Delete
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        document.getElementById('delivery-list').innerHTML = '<p style="color: var(--error);">Failed to load delivery charges</p>';
        console.error('Failed to load delivery charges:', error);
      }
    }

    function showDeliveryForm() {
      document.getElementById('delivery-form').style.display = 'block';
    }

    function hideDeliveryForm() {
      document.getElementById('delivery-form').style.display = 'none';
      document.getElementById('delivery-form-element').reset();
      document.getElementById('delivery-id').value = '';
    }

    function editDeliveryCharge(charge) {
      showDeliveryForm();
      document.getElementById('delivery-id').value = charge._id;
      document.getElementById('delivery-city').value = charge.city;
      document.getElementById('delivery-charge').value = charge.charge;
      document.getElementById('delivery-days').value = charge.estimatedDays || '';
      document.getElementById('delivery-status').value = charge.active.toString();
    }

    document.getElementById('delivery-form-element')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const chargeData = {
        city: document.getElementById('delivery-city').value,
        charge: parseFloat(document.getElementById('delivery-charge').value),
        estimatedDays: document.getElementById('delivery-days').value,
        isActive: document.getElementById('delivery-status').value === 'true'
      };

      try {
        const deliveryId = document.getElementById('delivery-id').value;
        if (deliveryId) {
          await api.updateDeliveryCharge(deliveryId, chargeData);
          toast.success(`Delivery charge for ${chargeData.city} updated successfully`);
        } else {
          await api.createDeliveryCharge(chargeData);
          toast.success(`Delivery charge for ${chargeData.city} added successfully`);
        }
        hideDeliveryForm();
        loadDeliveryCharges();
      } catch (error) {
        toast.error(error.message || 'Failed to save delivery charge');
      }
    });

    async function deleteDeliveryCharge(id) {
      Modal.confirm('Are you sure you want to delete this delivery charge?', async () => {
        try {
          await api.deleteDeliveryCharge(id);
          toast.success('Delivery charge deleted successfully');
          loadDeliveryCharges();
        } catch (error) {
          toast.error(error.message || 'Failed to delete delivery charge');
        }
      });
    }

    function showAlert(message, type) {
      toast.show(message, type);
    }

    // Reviews Management
    let allReviews = [];
    let currentReviewFilter = 'pending';

    async function loadReviews() {
      try {
        await filterReviews('pending');
        await updatePendingReviewsBadge();
      } catch (error) {
        console.error('Failed to load reviews:', error);
        document.getElementById('reviews-list').innerHTML = '<p>Failed to load reviews</p>';
      }
    }

    async function filterReviews(status) {
      currentReviewFilter = status;
      
      // Update button states
      document.querySelectorAll('[id^="filter-"][id$="-reviews"]').forEach(btn => {
        btn.classList.remove('btn');
        btn.classList.add('btn-secondary');
      });
      const activeBtn = document.getElementById(`filter-${status}-reviews`);
      if (activeBtn) {
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn');
      }

      try {
        const params = status === 'all' ? {} : { status };
        const response = await api.getAllReviews(params);
        allReviews = response.reviews || [];
        displayReviews(allReviews);
      } catch (error) {
        console.error('Failed to filter reviews:', error);
        document.getElementById('reviews-list').innerHTML = '<p>Failed to load reviews</p>';
      }
    }

    function displayReviews(reviews) {
      const container = document.getElementById('reviews-list');

      if (reviews.length === 0) {
        container.innerHTML = `<p style="text-align: center; padding: 2rem; color: var(--gray-600);">No ${currentReviewFilter === 'all' ? '' : currentReviewFilter} reviews found.</p>`;
        return;
      }

      container.innerHTML = reviews.map(review => `
        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: var(--shadow-md); margin-bottom: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
              <h4 style="margin: 0;">${review.title}</h4>
              <p style="margin: 0.5rem 0; color: var(--gray-600);">
                <strong>${review.user.name}</strong> (${review.user.email})
              </p>
              <div style="color: #ffa500; margin: 0.5rem 0;">
                ${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5 - review.rating)}
              </div>
            </div>
            <span class="status-badge ${review.status}">${review.status}</span>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <p style="margin: 0; line-height: 1.6;">${review.comment}</p>
          </div>
          
          <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem; margin-top: 1rem;">
            <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">
              <strong>Product:</strong> ${review.product.name} (${review.product.productId})
            </p>
            <p style="margin: 0.5rem 0 0 0; color: var(--gray-600); font-size: 0.9rem;">
              <strong>Submitted:</strong> ${new Date(review.createdAt).toLocaleString()}
              ${review.verified ? '<span style="color: #10b981; margin-left: 1rem;"><i class="fas fa-check-circle"></i> Verified Purchase</span>' : ''}
            </p>
          </div>
          
          ${review.status === 'pending' ? `
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
              <button class="btn" style="background: #10b981;" onclick="updateReviewStatus('${review._id}', 'approved')">
                <i class="fas fa-check"></i> Approve
              </button>
              <button class="btn" style="background: #ef4444;" onclick="updateReviewStatus('${review._id}', 'rejected')">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    async function updateReviewStatus(reviewId, status) {
      try {
        await api.updateReviewStatus(reviewId, status);
        toast.success(`Review ${status} successfully`);
        await filterReviews(currentReviewFilter);
        await updatePendingReviewsBadge();
      } catch (error) {
        toast.error(error.message || 'Failed to update review status');
      }
    }

    async function updatePendingReviewsBadge() {
      try {
        const response = await api.getAllReviews({ status: 'pending' });
        const pendingCount = response.total || 0;
        
        const badge = document.getElementById('pending-reviews-badge');
        if (pendingCount > 0) {
          badge.textContent = pendingCount;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      } catch (error) {
        console.error('Failed to update pending reviews badge:', error);
      }
    }
  </script>
</body>
</html>

